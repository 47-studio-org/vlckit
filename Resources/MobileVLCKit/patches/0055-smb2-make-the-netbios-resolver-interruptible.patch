From eabbd0a445873493b94ee1c9b1b92bf2a74813de Mon Sep 17 00:00:00 2001
From: Thomas Guillem <thomas@gllm.fr>
Date: Fri, 7 Jan 2022 14:33:28 +0100
Subject: [PATCH 55/55] smb2: make the netbios resolver interruptible

---
 modules/access/smb2.c | 34 ++++++++++++++++++++++++++++++++--
 1 file changed, 32 insertions(+), 2 deletions(-)

diff --git a/modules/access/smb2.c b/modules/access/smb2.c
index 83c1c820da..686f021633 100644
--- a/modules/access/smb2.c
+++ b/modules/access/smb2.c
@@ -48,8 +48,34 @@
 #include <smb2/libsmb2-raw.h>
 
 #ifdef HAVE_DSM
-# include <bdsm/netbios_ns.h>
-# include <bdsm/netbios_defs.h>
+# include <bdsm/bdsm.h>
+
+#if BDSM_VERSION_CURRENT >= 5
+
+static void
+netbios_ns_interrupt_callback(void *data)
+{
+    netbios_ns_abort(data);
+}
+
+static inline void
+netbios_ns_interrupt_register(netbios_ns *ns)
+{
+    vlc_interrupt_register(netbios_ns_interrupt_callback, ns);
+}
+
+static inline void
+netbios_ns_interrupt_unregister(void)
+{
+    vlc_interrupt_unregister();
+}
+
+#else
+
+#define netbios_ns_interrupt_register( ns ) do {} while (0)
+#define netbios_ns_interrupt_unregister() do {} while (0)
+#endif
+
 #endif
 
 #ifdef HAVE_ARPA_INET_H
@@ -750,6 +776,9 @@ vlc_smb2_resolve(stream_t *access, const char *host, unsigned port)
     /* Test if the host is a netbios name */
     char *out_host = NULL;
     netbios_ns *ns = netbios_ns_new();
+    if (!ns)
+        return NULL;
+    netbios_ns_interrupt_register(ns);
     uint32_t ip4_addr;
     if (netbios_ns_resolve(ns, host, NETBIOS_FILESERVER, &ip4_addr) == 0)
     {
@@ -757,6 +786,7 @@ vlc_smb2_resolve(stream_t *access, const char *host, unsigned port)
         if (inet_ntop(AF_INET, &ip4_addr, ip, sizeof(ip)))
             out_host = strdup(ip);
     }
+    netbios_ns_interrupt_unregister();
     netbios_ns_destroy(ns);
     return out_host;
 #else
-- 
2.32.0 (Apple Git-132)

