From 6368953005a2de7b7648553c3e4bda9ab243c6e6 Mon Sep 17 00:00:00 2001
From: Thomas Guillem <thomas@gllm.fr>
Date: Fri, 7 Jan 2022 14:28:20 +0100
Subject: [PATCH 57/76] dsm: make netbios_ns interruptible

(cherry picked from commit 088e3783b3fb9bb580fc80b775ae06de725081a7)
Signed-off-by: Thomas Guillem <thomas@gllm.fr>
---
 modules/access/dsm/access.c | 24 ++++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/modules/access/dsm/access.c b/modules/access/dsm/access.c
index 8e918d17eb..4f125feb77 100644
--- a/modules/access/dsm/access.c
+++ b/modules/access/dsm/access.c
@@ -155,10 +155,30 @@ smb_session_interrupt_unregister( void )
     vlc_interrupt_unregister();
 }
 
+static void
+netbios_ns_interrupt_callback( void *data )
+{
+    netbios_ns_abort( data );
+}
+
+static inline void
+netbios_ns_interrupt_register( netbios_ns *ns )
+{
+    vlc_interrupt_register( netbios_ns_interrupt_callback, ns );
+}
+
+static inline void
+netbios_ns_interrupt_unregister( void )
+{
+    vlc_interrupt_unregister();
+}
+
 #else
 
 #define smb_session_interrupt_register( sys ) do {} while (0)
 #define smb_session_interrupt_unregister() do {} while(0)
+#define netbios_ns_interrupt_register( ns ) do {} while (0)
+#define netbios_ns_interrupt_unregister() do {} while (0)
 
 #endif
 
@@ -297,12 +317,14 @@ static int get_address( stream_t *p_access )
         netbios_ns *p_ns = netbios_ns_new();
         if( p_ns == NULL )
             return VLC_EGENERIC;
+        netbios_ns_interrupt_register( p_ns );
 
         /* Is this a netbios name on this LAN ? */
         uint32_t ip4_addr;
 
         int ret = netbios_ns_resolve( p_ns, p_sys->url.psz_host,
                                       NETBIOS_FILESERVER, &ip4_addr);
+        netbios_ns_interrupt_unregister();
         netbios_ns_destroy( p_ns );
 
         if( ret == 0 )
@@ -333,10 +355,12 @@ static int get_address( stream_t *p_access )
     netbios_ns *p_ns = netbios_ns_new();
     if( p_ns == NULL )
         return VLC_EGENERIC;
+    netbios_ns_interrupt_register( p_ns );
 
     /* We have an IP address, let's find the NETBIOS name */
     const char *psz_nbt = netbios_ns_inverse( p_ns, p_sys->addr.s_addr );
 
+    netbios_ns_interrupt_unregister();
     netbios_ns_destroy( p_ns );
 
     if( psz_nbt != NULL )
-- 
2.32.0 (Apple Git-132)

